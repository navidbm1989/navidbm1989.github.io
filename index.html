<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Define character encoding and responsive viewport -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Set page title -->
    <title>Sacred Needles Consent Form</title>
    <!-- Preload the logo image using the URL from config -->
    <link rel="preload" href="<?= logoUrl ?>" as="image">
    <!-- Import Google Fonts for styling, including cursive options for signature adoption -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Dancing+Script:wght@400;700&family=Pacifico:wght@400&family=Teko:wght@400;700&family=Ubuntu:wght@400;700&family=Great+Vibes:wght@400&family=Lobster:wght@400&family=Satisfy:wght@400&family=Alex+Brush:wght@400&family=Cormorant+Garamond:wght@400;700&family=Public+Sans:wght@400;700&family=Open+Sans:wght@400;700&family=Hind:wght@400;700&family=Libre+Baskerville:wght@400;700&family=Lexend:wght@400;700&family=Plus+Jakarta+Sans:wght@400;700&family=Lato:wght@400;700&family=Work+Sans:wght@400;700&family=Red+Hat+Display:wght@400;700&family=EB+Garamond:wght@400;700&family=Fleur+De+Leah:wght@400&family=Monsieur+La+Doulaise:wght@400&family=Mea+Culpa:wght@400&family=Ballet:wght@400&family=Miss+Fajardose:wght@400&display=swap" rel="stylesheet">

    <!-- Include Signature Pad library for manual signature capture -->
    <script src="https://unpkg.com/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <!--Iconscout provides a CDN through UNPKG, which hosts a wide range of icons, including Instagram and Facebook logos, in SVG format-->
    <script src="https://unpkg.com/@iconscout/unicons@4.0.8/dist/unicons.js"></script>
    <link rel="stylesheet" href="https://unicons.iconscout.com/release/v4.0.0/css/line.css">
    <style>
        /* Default body styling: font, background, text color, and padding */
        body {
            //font-family: 'Roboto', sans-serif; /* Clean, modern font */
            //font-family: 'EB Garamond', serif; /* Test diff fonts */
            font-family: 'Libre Baskerville', serif; /* Test diff fonts */
            //font-family: 'Cormorant Garamond'; /* Test diff fonts */
            background-color: #fdf6f0; /* Light peach background */
            color: #000; /* Black text for readability */
            margin: 0;
            padding: 10px;
            font-size: 16px; /* Base font size */
        }
        /* Main container: Centers and styles the form container */
          #main-container {
              /* Limits width to 800px for readability on larger screens */
              max-width: 800px; 
              /* Centers the container horizontally */
              margin: 0 auto; 
              /* White background for a clean, professional look */
              background-color: #ffffff;
              /* Padding inside the container for content spacing */
              padding: 15px;
              /* Rounded corners for a softer, modern aesthetic */
              border-radius: 10px; 
              /* Subtle shadow adds depth and elevation */
              box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); 
          }

          /* Page class: Default styling for each page section, hidden initially */
          .page {
              /* Hides pages by default, shown via JavaScript */
              display: none;
              /* Flex column layout stacks content and buttons vertically */
              flex-direction: column;
          }

          /* Welcome page: Specific styling for the initial greeting page */
          #welcome-page {
              /* Displays the page as flex (overriding 'none' when active) */
              display: flex;
              /* Centers text for a welcoming, balanced appearance */
              text-align: center;
          }

          /* Thank you page: Styling for the submission confirmation page */
          #thank-you-page {
              /* Centers text to emphasize the completion message */
              text-align: center;
          }

          /* Page content: Ensures content takes up available space */
          .page-content {
              /* Flex-grow allows content to expand, shrink prevents overflow, auto basis for natural sizing */
              flex: 1 0 auto;
          }

          /* Page buttons: Styling for navigation buttons at the bottom of each page */
          .page-buttons {
              /* Adds space above buttons for separation from content */
              margin-top: 10px;
              /* Centers buttons horizontally */
              text-align: center;
              /* Removes bottom margin to align with container edge */
              margin-bottom: 0;
          }

          /* Error message: Styling for validation or submission errors */
          .error-message {
              /* Coral red color to draw attention to errors */
              color: #ff6f61; 
              /* Centers error text for visibility */
              text-align: center;
              /* Space above error message for separation */
              margin-top: 10px;
              /* Hidden by default, shown via JavaScript */
              display: none;
              /* Preserves newlines and wraps text for multi-line errors */
              white-space: pre-line; 
          }

          /* Headings: Styling for h1 and h2 elements */
          h1, h2 {
              /* Dark red color ties to branding theme */
              //color: #8b0000; 
            //Black
              color: #000000; 
              /* Centers headings for emphasis and symmetry */
              text-align: center;
              /* Larger font size (1.6 times base) for prominence */
              font-size: 1.6em;
          }

          /* Paragraphs: General text styling for readability */
          p {
              /* Increased line height improves legibility */
              line-height: 1.6;
              /* Vertical spacing between paragraphs */
              margin: 10px 0;
          }

          /* Labels: Styling for form field labels */
          label {
              /* Block display stacks labels above inputs */
              display: block;
              /* Space above labels for separation */
              margin-top: 10px;
              /* Left-aligned text for standard form layout */
              text-align: left;
              /* Normal weight avoids overly bold labels */
              font-weight: normal;
          }

          /* Address legend: Specific styling for the address fieldset legend */
          #address legend {
              /* Normal weight keeps it subtle */
              font-weight: normal;
              /* Black text for readability */
              color: #000;
              /* Slightly larger font for distinction */
              font-size: 1.2em;
          }

          /* Inputs, selects, canvas: Shared styling for form elements */
          input, select, canvas {
              /* Full width ensures elements fill their container */
              width: 100%;
              /* Caps width at 400px for aesthetic consistency */
              max-width: 400px; 
              /* Padding inside elements for comfortable input */
              padding: 8px;
              /* Space above for separation from labels */
              margin-top: 5px;
              /* Light gray border for definition */
              border: 1px solid #ccc; 
              /* Rounded corners match container style */
              border-radius: 5px;
              /* Includes padding in width calculation */
              box-sizing: border-box;
              /* Consistent font size with body text */
              font-size: 16px;
          }

          /* Personal info page: Overrides for specific elements */
          #personal-info-page select, #personal-info-page input[type="file"] {
              /* Full width for selects and file inputs on this page */
              max-width: 100%;
          }

          /* Consent item inputs: Styling for initial inputs in consent form */
          .consent-item input {
              /* Smaller width for initials fields */
              max-width: 60px;
          }

          /* Consent item buttons: Styling for inline buttons in consent items */
          .consent-item button {
              /* Smaller padding for compact buttons */
              padding: 5px 10px;
              /* Smaller font size for inline use */
              font-size: 14px;
              /* Space to the right for separation */
              margin-right: 10px;
          }

          /* Invalid input focus: Visual feedback for invalid fields */
          input:focus:invalid, select:focus:invalid, #signature-canvas.highlight-error {
              /* Red border highlights errors when focused */
              border-color: #ff6f61;
          }

          /* Buttons: General styling for all buttons */
          button {
              /* Dark red background aligns with branding */
              //background-color: #8b0000; 
              // Black
              background-color: #000000; 
              /* White text contrasts with dark background */
              color: #fff;
              /* Generous padding for clickable area */
              padding: 12px 24px;
              /* No border for a clean look */
              border: none;
              /* Rounded corners match other elements */
              border-radius: 5px;
              /* Pointer cursor indicates interactivity */
              cursor: pointer;
              /* Margin for spacing, especially above */
              margin: 15px 10px 0 0;
              /* Consistent font size with inputs */
              font-size: 16px;
          }

          /* Button hover: Interaction state for buttons */
          button:hover {
              /* Darker red/purple shade for hover feedback */
              background-color: #6b3e57; 
          }

          /* Error button: Specific styling for error-state buttons */
          button.error {
              /* Coral red background for error emphasis */
              background-color: #ff6f61;
              /* White text maintains contrast */
              color: #fff;
          }

          /* Personal info grid: Two-column layout for personal info fields */
          .personal-info-grid {
              /* Grid layout with two equal columns */
              display: grid;
              grid-template-columns: 1fr 1fr; 
              /* Spacing between grid items */
              gap: 10px;
              /* Bottom margin for separation from next section */
              margin-bottom: 10px;
          }

          /* Address fieldset: Styling for the address section */
          #address {
              /* Light gray border defines the section */
              border: 1px solid #ccc;
              /* Padding inside fieldset for content spacing */
              padding: 5px;
              /* Rounded corners for consistency */
              border-radius: 5px;
              /* Space above for separation */
              margin-top: 10px;
          }

          /* Address grid: Two-column layout for address fields */
          .address-grid {
              /* Grid layout with two equal columns */
              display: grid;
              grid-template-columns: 1fr 1fr;
              /* Spacing between grid items */
              gap: 10px;
          }

          /* Address grid labels: Adjusts label spacing */
          .address-grid label {
              /* Reduced top margin for tighter layout */
              margin-top: 5px;
          }

          /* Preview section: Styling for signature preview area */
          #preview {
              /* Space above for separation from font selection */
              margin-top: 20px;
              /* Larger font size for visibility */
              font-size: 1.3em;
          }

          /* Signature canvas: Styling for the manual signature area */
          #signature-canvas {
              /* Light gray border defines the canvas */
              border: 1px solid #ccc;
              /* Full width up to a maximum */
              width: 100%;
              /* Caps width at 600px for consistency */
              max-width: 600px; 
              /* Fixed height ensures uniform signature space */
              height: 120px; 
              /* Block display ensures proper sizing */
              display: block; 
          }

          /* Signature pad: Container for canvas and clear button */
          #signature-pad {
              /* Flex column stacks canvas and button vertically */
              display: flex;
              flex-direction: column;
              /* Centers items horizontally within the container */
              align-items: center; 
              /* Full width up to a maximum */
              width: 100%;
              /* Matches canvas max-width for alignment */
              max-width: 600px; 
              /* Centers the container horizontally */
              margin: 0 auto; 
          }

          /* Clear button inside signature pad: Specific styling */
          #signature-pad button {
              /* Space above button, no horizontal margin for centering */
              margin: 10px 0 0 0; 
              /* Smaller padding for a compact button */
              padding: 8px 16px; 
              /* Slightly smaller font for proportionality */
              font-size: 14px; 
          }

          /* Loading indicator: Full-screen overlay for submission processing */
          #loading {
              /* Centers text within the overlay */
              text-align: center;
              /* Hidden by default, shown via JavaScript */
              display: none;
              /* Fixed position covers the entire viewport */
              position: fixed;
              /* Starts at the top-left corner */
              top: 0;
              left: 0;
              /* Full width and height of the viewport */
              width: 100%;
              height: 100%;
              /* Semi-transparent white background for overlay effect */
              background-color: rgba(255, 255, 255, 0.8);
              /* High z-index ensures it’s on top of other content */
              z-index: 1000; 
          }

          /* Loading content: Centers the loading image and text */
          #loading div {
              /* Absolute positioning for centering */
              position: absolute;
              /* Vertically centered at 50% from top */
              top: 50%;
              /* Horizontally centered at 50% from left */
              left: 50%;
              /* Translates back by half its size for true centering */
              transform: translate(-50%, -50%);
          }

          /* Loading image: Styling for the loading animation */
          #loading img {
              /* Fixed width for consistent appearance */
              width: 300px;
              /* Block display centers it horizontally */
              display: block;
              /* Auto margins for horizontal centering */
              margin: 0 auto;
          }

          /* Loading text: Styling for the processing message */
          #loading p {
              /* Space above text for separation from image */
              margin-top: 10px;
              /* Readable font size */
              font-size: 16px;
              /* Black text for visibility */
              color: #000;
          }

          /* Consent items: Styling for each consent statement */
          .consent-item {
              /* Flex layout aligns items horizontally */
              display: flex;
              /* Aligns items at the top for consistent appearance */
              align-items: flex-start;
              /* Bottom margin separates items */
              margin-bottom: 15px;
              /* Left margin for indentation */
              margin-left: 20px;
              /* Right margin for symmetry */
              margin-right: 20px;
          }

          /* Consent item paragraphs: Text styling within consent items */
          .consent-item p {
              /* Justified text for a professional look */
              text-align: justify;
              /* No margin to fit within flex container */
              margin: 0;
              /* Full width within the flex item */
              width: 100%;
          }

          /* Consent item spans and inputs: Spacing for initials/buttons */
          .consent-item span, .consent-item input {
              /* Space to the right for separation */
              margin-right: 15px;
              /* Minimum width ensures consistent spacing */
              min-width: 60px;
          }

          /* Font style options: Ensures options inherit parent font */
          #font-style option {
              /* Inherits font from parent for consistency */
              font-family: inherit;
          }
          /* Increase font size for the font style dropdown */
          #font-style {
              font-size: 20px; /* Adjust as needed, e.g., 20px for even larger */
          }

          /* Increase font size for preview text */
          #initials-preview, #signature-preview {
              font-size: 30px; /* Adjust as needed, e.g., 28px for even larger */
          }
          /* Specific font styles for options: Applies unique fonts to each option */
          #font-style option[value="Dancing Script"] { 
              /* Cursive font for a handwritten look */
              font-family: 'Dancing Script', cursive; 
          }
          #font-style option[value="Pacifico"] { 
              /* Casual, rounded cursive font */
              font-family: 'Pacifico', cursive; 
          }
          #font-style option[value="Great Vibes"] { 
              /* Elegant, flowing cursive font */
              font-family: 'Great Vibes', cursive; 
          }
          #font-style option[value="Lobster"] { 
              /* Bold, playful cursive font */
              font-family: 'Lobster', cursive; 
          }
          #font-style option[value="Satisfy"] { 
              /* Smooth, stylish cursive font */
              font-family: 'Satisfy', cursive; 
          }
          #font-style option[value="Alex Brush"] { 
              /* Delicate, handwritten cursive font */
              font-family: 'Alex Brush', cursive; 
          }
          #font-style option[value="Fleur De Leah"] { 
              /* Ornate, decorative cursive font */
              font-family: 'Fleur De Leah', cursive; 
          }
          #font-style option[value="Monsieur La Doulaise"] { 
              /* Sophisticated, formal cursive font */
              font-family: 'Monsieur La Doulaise', cursive; 
          }
          #font-style option[value="Mea Culpa"] { 
              /* Artistic, expressive cursive font */
              font-family: 'Mea Culpa', cursive; 
          }
          #font-style option[value="Ballet"] { 
              /* Graceful, elegant cursive font */
              font-family: 'Ballet', cursive; 
          }
          #font-style option[value="Miss Fajardose"] { 
              /* Unique, stylized cursive font */
              font-family: 'Miss Fajardose', cursive; 
          }

          /* Highlight error: Visual feedback for invalid fields */
          .highlight-error {
              /* Thick red border to indicate errors */
              border: 2px solid red;
          }

          /* Responsive design: Adjusts layout for smaller screens */
          @media (max-width: 600px) {
              #main-container {
                  /* Reduced padding on mobile for more content space */
                  padding: 10px; 
              }
              .personal-info-grid, .address-grid {
                  /* Switches to single column on small screens */
                  grid-template-columns: 1fr; 
              }
              /* Adjust signature canvas and pad for smaller screens */
              #signature-canvas, #signature-pad {
                  /* Full width on mobile for usability */
                  max-width: 100%; 
              }
          }

          /* Adopted signature: Styling for the final adopted signature */
          .adopted-signature {
              /* Larger font size for visibility and emphasis */
              font-size: 32px;
          }

          /* Textarea: Styling for multi-line text inputs */
          textarea {
              /* Full width up to a maximum */
              width: 100%;
              /* Caps width at 600px for consistency */
              max-width: 600px;
              /* Taller height for multi-line input */
              height: 80px;
              /* Padding inside for comfortable typing */
              padding: 8px;
              /* Space above for separation */
              margin-top: 5px;
              /* Light gray border matches other inputs */
              border: 1px solid #ccc;
              /* Rounded corners for consistency */
              border-radius: 5px;
              /* Includes padding in width calculation */
              box-sizing: border-box;
              /* Consistent font size with other inputs */
              font-size: 16px;
              /* Allows vertical resizing only */
              resize: vertical;
          }

          /* Input placeholder: Styling for placeholder text in inputs */
          input::placeholder {
              /* Light gray color for subtle hint */
              color: #888; 
              /* Italic style distinguishes placeholder from entered text */
              font-style: italic;
              /* Reduced opacity for a faded effect */
              opacity: 0.7;
          }
          /* New style for the file upload guide */
            .file-upload-guide {
              color: #555;
              font-size: 14px;
              font-style: italic;
              margin: 10px 0;
              padding: 10px;
              background-color: #f9f9f9;
              border-left: 4px solid #4CAF50;
              border-radius: 4px;
            }
            /* Styling for the social media links container */
              .social-media-container {
                  margin: 20px 0;
                  text-align: center;
              }

              /* Styling for each social media link item */
              .social-media-item {
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  margin: 10px 0;
              }

              /* Styling for the social media icons */
              .social-media-item i {
                  font-size: 24px; /* Size of the icons */
                  margin-right: 10px; /* Space between icon and text */
                  color: #000000; /* Match your app's button color */
              }

              /* Styling for the social media links */
              .social-media-item a {
                  color: #000000; /* Match your app's text color */
                  text-decoration: none;
                  font-size: 16px;
              }

              .social-media-item a:hover {
                  text-decoration: underline;
                  color: #6b3e57; /* Match your button hover color */
              }
              .social-media-item .uil-instagram {
                  color: #E1306C; /* Instagram pink */
              }
              .social-media-item .uil-facebook-f {
                  color: #1877F2; /* Facebook blue */
              }
    </style>
</head>
<body>
    <!-- Main container for all pages -->
    <div id="main-container">
        <!-- Welcome Page: Initial greeting -->
        <div id="welcome-page" class="page">
            <div class="page-content">
                <!-- Logo image with src set from config and fallback -->
                <img id="logo-image" 
                    src="<?= logoUrl ?>" 
                    alt="Sacred Needles Logo" 
                    style="display: block; margin: 0 auto 20px; max-width: 200px;" 
                    onerror="this.src='https://via.placeholder.com/200x100?text=Logo+Not+Found';">
                <h1>Welcome to Sacred Needles</h1>
                <p>Thank you for choosing Sacred Needles for your tattoo. Before we begin, we require you to complete this consent form. This is a professional and legal necessity to ensure you are fully informed of the tattooing process and associated risks.</p>
                <div class="error-message"></div>
            </div>
            <div class="page-buttons">
                <button onclick="showPage('personal-info-page')">Proceed</button>
            </div>
        </div>

        <!-- Personal Info Page: Collects client details -->
        <div id="personal-info-page" class="page">
            <div class="page-content">
                <h2>Personal Information</h2>
                <p>All fields are required.</p>
                <form id="personal-info-form">
                    <div class="personal-info-grid">
                        <div>
                            <label for="full-name-info">Full Name: <span style="color: #ff6f61;">*</span></label>
                            <input type="text" id="full-name-info" required>
                        </div>
                        <div>
                            <label for="email">Email: <span style="color: #ff6f61;">*</span></label>
                            <input type="email" id="email" required>
                        </div>
                        <div>
                            <label for="phone">Phone Number: <span style="color: #ff6f61;">*</span></label>
                            <input type="tel" id="phone" required>
                        </div>
                        <div>
                            <label for="dob">Date of Birth: <span style="color: #ff6f61;">*</span></label>
                            <input type="date" id="dob" required>
                        </div>
                        <div style="grid-column: 1 / -1;">
                            <label for="gender">Gender: <span style="color: #ff6f61;">*</span></label>
                            <select id="gender" required>
                                <option value="">Select</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                            </select>
                        </div>
                    </div>
                    <fieldset id="address">
                        <legend>Address</legend>
                        <div class="address-grid">
                            <div>
                                <label for="street">Street: <span style="color: #ff6f61;">*</span></label>
                                <input type="text" id="street" required placeholder="123 Main St">
                            </div>
                            <div>
                                <label for="city">City: <span style="color: #ff6f61;">*</span></label>
                                <input type="text" id="city" required placeholder="Houston">
                            </div>
                            <div>
                                <label for="state">State: <span style="color: #ff6f61;">*</span></label>
                                <input type="text" id="state" required placeholder="TX">
                            </div>
                            <div>
                                <label for="zipcode">Zipcode: <span style="color: #ff6f61;">*</span></label>
                                <input type="text" id="zipcode" required placeholder="77001">
                            </div>
                        </div>
                    </fieldset>
                    <label for="id-type">Form of ID: <span style="color: #ff6f61;">*</span></label>
                    <select id="id-type" required>
                        <option value="">Select</option>
                        <option value="Driver’s License">Driver’s License</option>
                        <option value="State ID">State ID</option>
                        <option value="Military ID">Military ID</option>
                        <option value="Passport">Passport</option>
                    </select>
                    <!-- Add the guide message here -->
                      <p class="file-upload-guide">
                        Please upload images of your ID (front and back). Accepted formats: JPEG, PNG, GIF, BMP, HEIC. Maximum file size: 10MB per image.
                      </p>
                    <label for="front-id">Front of Photo ID: <span style="color: #ff6f61;">*</span></label>
                    <input type="file" id="front-id" accept="image/*" required>
                    <label for="back-id">Back of Photo ID: <span style="color: #ff6f61;">*</span></label>
                    <input type="file" id="back-id" accept="image/*" required>
                </form>
                <div class="error-message"></div>
            </div>
            <div class="page-buttons">
                <button onclick="proceedToTattooDescription()">Proceed</button>
            </div>
        </div>

        <!-- Tattoo Description Page: Collects tattoo details -->
        <div id="tattoo-description-page" class="page">
            <div class="page-content">
                <h2>Tattoo Description</h2>
                <p>Please provide details about your desired tattoo. All fields are required.</p>
                <form id="tattoo-description-form">
                    <label for="placement">Placement: <span style="color: #ff6f61;">*</span></label>
                    <textarea id="placement" placeholder="Please provide a concise description of the intended location for your tattoo" required></textarea>
                    <label for="size">Size: <span style="color: #ff6f61;">*</span></label>
                    <select id="size" required>
                        <option value="">Select a size</option>
                        <option value="Small">Small</option>
                        <option value="Medium">Medium</option>
                        <option value="Large">Large</option>
                    </select>
                    <label for="ink-selection">Ink Selection: <span style="color: #ff6f61;">*</span></label>
                    <select id="ink-selection" required>
                        <option value="">Select an ink type</option>
                        <option value="Black & Gray Ink">Black & Gray Ink</option>
                        <option value="Colorwork Ink">Colorwork Ink</option>
                        <option value="Both">Both</option>
                    </select>
                </form>
                <div class="error-message"></div>
            </div>
            <div class="page-buttons">
                <button onclick="proceedToSignaturePreference()">Proceed</button>
            </div>
        </div>

        <!-- Signature Preference Page: Chooses signature method -->
        <div id="signature-preference-page" class="page">
            <div class="page-content">
                <h2>Signature Preference</h2>
                <p>Please choose how you would like to provide your initials and signature.</p>
                <label for="signature-method">Signature Method: <span style="color: #ff6f61;">*</span></label>
                <select id="signature-method" required onchange="handleSignatureMethodChange()">
                    <option value="">Select an option</option>
                    <option value="adopt">Adopt a Font</option>
                    <option value="manual">Manual</option>
                </select>
                <div id="font-selection" style="display: none;">
                    <label for="font-style">Font Style: <span style="color: #ff6f61;">*</span></label>
                    <select id="font-style" required onchange="updatePreview()">
                        <option value="">Select a font</option>
                        <option value="Fleur De Leah">Fleur De Leah</option>
                        <option value="Monsieur La Doulaise">Monsieur La Doulaise</option>
                        <option value="Mea Culpa">Mea Culpa</option>
                        <option value="Ballet">Ballet</option>
                        <option value="Alex Brush">Alex Brush</option>
                        <option value="Miss Fajardose">Miss Fajardose</option>
                        <option value="Dancing Script">Dancing Script</option>
                        <option value="Pacifico">Pacifico</option>
                        <option value="Great Vibes">Great Vibes</option>
                        <option value="Lobster">Lobster</option>
                        <option value="Satisfy">Satisfy</option>

                    </select>
                    <div id="preview">
                        <p>Initials Preview: <span id="initials-preview"></span></p>
                        <p>Signature Preview: <span id="signature-preview"></span></p>
                    </div>
                </div>
                <div class="error-message"></div>
            </div>
            <div class="page-buttons">
                <button onclick="proceedToConsentForm()">Proceed</button>
            </div>
        </div>

        <!-- Consent Form Page: Displays consent terms and collects signatures -->
        <div id="consent-form-page" class="page">
            <div class="page-content">
                <h1 style="text-align: center;">Sacred Needles LLC</h1>
                <h2 style="text-align: center;">TATTOO CONSENT FORM</h2>
                <p style="text-align: left; margin-bottom: 20px;">
                    In consideration of receiving a tattoo from SACRED NEEDLES LLC, including its artists, associates, apprentices, agents, or any employees (hereinafter referred to as the “Tattoo Studio”), I agree to the following:
                </p>
                <div id="consent-items">
                    <!-- Dynamically generated consent items -->
                </div>
                <div id="signature-section">
                    <label for="signature">Signature: <span style="color: #ff6f61;">*</span></label>
                    <div id="signature-pad" style="display: none;">
                        <canvas id="signature-canvas"></canvas>
                        <button onclick="clearSignature()">Clear</button>
                    </div>
                    <div id="adopt-signature" style="display: none;">
                        <button onclick="adoptSignature()">Click to Sign</button>
                        <span id="signature-text"></span>
                    </div>
                    <label for="date">Date:</label>
                    <input type="date" id="date" readonly>
                </div>
                <div class="error-message"></div>
            </div>
            <div class="page-buttons">
                <button onclick="submitForm()">Submit</button>
            </div>
        </div>

        <!-- Thank You Page: Submission confirmation -->
        <div id="thank-you-page" class="page">
            <div class="page-content">
                <h2 id="thankYouMessage"></h2>
                <p id="submissionMessage"></p>
                <div id="socialMediaLinks" class="social-media-container">
                    <!-- Social media links with icons will be dynamically inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Indicator: Shows during form submission -->
    <div id="loading" style="display: none;">
       <div>
          <img id="loading-image" alt="Loading...">
          <p>Processing, please wait...</p>
        </div>
    </div>

    <script>

              /**
         * Sacred Needles Consent Form Web App - Client-Side Script
         *
         * Overview:
         * This script manages the front-end of a tattoo consent form for Sacred Needles LLC, built as a Google Apps Script web app.
         * It provides a multi-page interface to collect client info, tattoo details, and consent, with validation and signature options,
         * submitting data to the server for PDF generation and storage.
         *
         * Structure:
         * - Welcome Page: Greets users with a logo and intro.
         * - Personal Info Page: Collects personal details and ID uploads.
         * - Tattoo Description Page: Gathers tattoo placement, size, and ink type.
         * - Signature Preference Page: Allows choosing between font-based or manual signatures.
         * - Consent Form Page: Shows consent terms, collects initials/signatures.
         * - Thank You Page: Confirms submission with social media links.
         *
         * Inputs:
         * - Personal: Full Name, Email, Phone, Gender, Address (Street, City, State, Zip), DOB, ID Type, Photo IDs
         * - Tattoo: Placement, Size, Ink Selection
         * - Consent: Signature Method (Adopt/Manual), Initials (14 statements), Signature, Date
         *
         * Intentions:
         * 1. Legal Compliance: Ensures informed consent with validated inputs.
         * 2. Data Collection: Captures all required info seamlessly.
         * 3. User Experience: Provides clear navigation and error feedback.
         * 4. Automation: Prepares data for server-side processing.
         *
         * Key Features:
         * - Multi-page navigation with showPage()
         * - Form validation (e.g., proceedToTattooDescription(), proceedToSignaturePreference())
         * - Signature handling: adopt (font-based) or manual (SignaturePad)
         * - Dynamic consent generation with generateConsentItems()
         * - File upload handling and submission with submitForm()
         *
         * Customization Instructions:
         * 1. Branding: Update logo in config data (loaded via loadConfigData()).
         * 2. Business Name: Replace 'Sacred Needles' in HTML and messages (e.g., h1, thankYouMessage).
         * 3. Consent Terms: Adjust items array in generateConsentItems() for client needs.
         * 4. Fonts: Modify font options in #font-style select if desired.
         * 5. Test: Ensure validation and submission work with new client setup.
         */

        //console.log('Script started');
        // Global variables for state management
        let signatureMethod = ''; // Tracks chosen signature method (adopt/manual)
        let selectedFont = ''; // Stores selected font for adopted signature
        let fullName = ''; // Stores client's full name
        let initials = ''; // Stores generated initials
        let signaturePad; // SignaturePad instance for manual signatures
        let socialMediaData = null; // Global variable to store social media data

        // Load config data on page load from server-side Google Apps Script
        // Load config data on page load
        // Fetch social media links on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, fetching config and social media data');
            google.script.run
                .withSuccessHandler(loadConfigData)
                .withFailureHandler((error) => {
                    console.error('Failed to fetch config data:', error);
                    setFallbackImages();
                })
                .getConfigData();
            google.script.run
                .withSuccessHandler(function(socialMedia) {
                    socialMediaData = socialMedia;
                    console.log('Social media data pre-fetched:', socialMediaData);
                })
                .withFailureHandler((error) => {
                    console.error('Failed to fetch social media data:', error);
                    socialMediaData = {
                        instagramHandle: '@sacred.needles',
                        instagramLink: 'https://www.instagram.com/sacred.needles/',
                        facebookPage: 'sacred.needlesfb',
                        facebookLink: 'https://www.facebook.com/sacred.needlesfb/'
                    }; // Fallback data
                })
                .getSocialMediaLinks();
        });

        // Function to load config data and set image URLs
        function loadConfigData(config) {
            try {
                //console.log('Config Data Loaded:', config);

                // Set logo image
                const logoImageUrl = config.LogoImage;
                const logoElement = document.getElementById('logo-image');
                if (logoElement) {
                    if (logoImageUrl && isValidImageUrl(logoImageUrl)) {
                        logoElement.src = logoImageUrl;
                        logoElement.onerror = () => {
                            //console.warn('Logo image failed to load:', logoImageUrl);
                            logoElement.src = 'https://via.placeholder.com/200x100?text=Logo+Not+Found';
                        };
                        //console.log('Logo image src set to:', logoImageUrl);
                    } else {
                        logoElement.src = 'https://via.placeholder.com/200x100?text=Logo+Not+Found';
                        //console.warn('Logo image URL is missing or invalid:', logoImageUrl);
                    }
                } else {
                    console.warn('Element with ID "logo-image" not found');
                }

                // Set loading image
                const loadingImageUrl = config.LoadingImage;
                const loadingElement = document.getElementById('loading-image');
                if (loadingElement) {
                    if (loadingImageUrl && isValidImageUrl(loadingImageUrl)) {
                        loadingElement.src = loadingImageUrl;
                        loadingElement.onerror = () => {
                            //console.warn('Loading image failed to load:', loadingImageUrl);
                            loadingElement.src = 'https://via.placeholder.com/300x100?text=Loading+Image+Not+Found';
                        };
                        //console.log('Loading image src set to:', loadingImageUrl);
                    } else {
                        loadingElement.src = 'https://via.placeholder.com/300x100?text=Loading+Image+Not+Found';
                        //console.warn('Loading image URL is missing or invalid:', loadingImageUrl);
                    }
                } else {
                    console.warn('Element with ID "loading-image" not found');
                }
            } catch (error) {
                console.error('Error in loadConfigData:', error);
                setFallbackImages();
            }
        }

        // Helper function to set fallback images if config fails
        function setFallbackImages() {
            const logoElement = document.getElementById('logo-image');
            if (logoElement) {
                logoElement.src = 'https://via.placeholder.com/200x100?text=Logo+Not+Found';
            }
            const loadingElement = document.getElementById('loading-image');
            if (loadingElement) {
                loadingElement.src = 'https://via.placeholder.com/300x100?text=Loading+Image+Not+Found';
            }
        }

        // Helper function to validate image URLs
        function isValidImageUrl(url) {
            return typeof url === 'string' && (url.startsWith('http://') || url.startsWith('https://'));
        }

        // Calculate age based on date of birth for validation
        function calculateAge(dob) {
            console.log('Calculating age for DOB: ' + dob);
            const birthDate = new Date(dob);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            console.log('Calculated age: ' + age);
            return age;
        }

        // Show a specific page, hide others, and reset error messages
          function showPage(pageId) {
              console.log('Showing page: ' + pageId);
              document.querySelectorAll('.page').forEach(page => page.style.display = 'none');
              document.getElementById(pageId).style.display = 'flex';
              const loading = document.getElementById('loading');
              if (loading) loading.style.display = 'none';
              document.querySelectorAll('.error-message').forEach(msg => {
                  msg.style.display = 'none';
                  msg.textContent = '';
              });
          }

        // Handle signature method selection change (adopt or manual)
        function handleSignatureMethodChange() {
              signatureMethod = document.getElementById('signature-method').value;
              console.log('Signature method selected: ' + signatureMethod);
              document.getElementById('font-selection').style.display = signatureMethod === 'adopt' ? 'block' : 'none';
              if (signatureMethod === 'adopt') {
                  updatePreview(); // Refresh preview when switching to adopt
              }
              const errorMessage = document.querySelector('#signature-preference-page .error-message');
              if (errorMessage) errorMessage.style.display = 'none';
          }

        // Update signature and initials preview with selected font
        function updatePreview() {
            selectedFont = document.getElementById('font-style').value;
            console.log('Updating preview with font: ' + selectedFont);
            const initialsPreview = document.getElementById('initials-preview');
            const signaturePreview = document.getElementById('signature-preview');
            
            // Use the client's initials and full name from personal info
            initialsPreview.textContent = initials || 'Initials'; // Fallback if not set yet
            signaturePreview.textContent = fullName || 'Full Name'; // Fallback if not set yet
            
            initialsPreview.style.fontFamily = `'${selectedFont}', cursive`;
            signaturePreview.style.fontFamily = `'${selectedFont}', cursive`;
            
            console.log('Initials preview font: ' + initialsPreview.style.fontFamily);
            console.log('Signature preview font: ' + signaturePreview.style.fontFamily);
        }

        // Generate initials from full name (e.g., "John Doe" -> "JD")
        function getInitials(name) {
            console.log('Generating initials for name: ' + name);
            const initialsResult = name.split(' ').map(word => word[0].toUpperCase()).join('');
            console.log('Generated initials: ' + initialsResult);
            return initialsResult;
        }

        // Validate personal information and proceed to tattoo description page
        function proceedToTattooDescription() {
            console.log('Validating personal information');
            const form = document.getElementById('personal-info-form');
            const errorMessage = document.querySelector('#personal-info-page .error-message');
            errorMessage.style.display = 'none';
            errorMessage.textContent = '';
            let invalidField = null;
            let errors = [];

            // Get all input and select elements
            const fullNameInput = document.getElementById('full-name-info');
            const emailInput = document.getElementById('email');
            const phoneInput = document.getElementById('phone');
            const dobInput = document.getElementById('dob');
            const genderSelect = document.getElementById('gender');
            const streetInput = document.getElementById('street');
            const cityInput = document.getElementById('city');
            const stateInput = document.getElementById('state');
            const zipcodeInput = document.getElementById('zipcode');
            const idTypeSelect = document.getElementById('id-type');
            const frontIdInput = document.getElementById('front-id');
            const backIdInput = document.getElementById('back-id');

            // Reset highlight on all fields
            [fullNameInput, emailInput, phoneInput, dobInput, genderSelect, streetInput, cityInput, stateInput, zipcodeInput, idTypeSelect, frontIdInput, backIdInput].forEach(element => {
                element.classList.remove('highlight-error');
            });

            // Full Name validation
            const fullNameValue = fullNameInput.value.trim();
            const nameRegex = /^[A-Za-z\s'-]+$/; // Letters, spaces, hyphens, apostrophes
            if (!fullNameValue) {
                errors.push('Full Name is required.');
                fullNameInput.classList.add('highlight-error');
                if (!invalidField) invalidField = fullNameInput;
            } else if (fullNameValue.split(' ').filter(word => word).length < 2 || !nameRegex.test(fullNameValue)) {
                errors.push('Full Name must include at least a first and last name with no numbers or special characters.');
                fullNameInput.classList.add('highlight-error');
                if (!invalidField) invalidField = fullNameInput;
            }

            // Email validation
            const emailValue = emailInput.value.trim();
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/; // Basic email format
            if (!emailValue) {
                errors.push('Email is required.');
                emailInput.classList.add('highlight-error');
                if (!invalidField) invalidField = emailInput;
            } else if (!emailRegex.test(emailValue)) {
                errors.push('Please enter a valid email address (e.g., example@domain.com).');
                emailInput.classList.add('highlight-error');
                if (!invalidField) invalidField = emailInput;
            }

            // Phone Number validation
            const phoneValue = phoneInput.value.trim();
            const phoneRegex = /^\(?([0-9]{3})\)?[-. ]?([0-9]{3})[-. ]?([0-9]{4})$/; // US phone formats
            if (!phoneValue) {
                errors.push('Phone Number is required.');
                phoneInput.classList.add('highlight-error');
                if (!invalidField) invalidField = phoneInput;
            } else if (!phoneRegex.test(phoneValue)) {
                errors.push('Please enter a valid US phone number (e.g., 123-456-7890).');
                phoneInput.classList.add('highlight-error');
                if (!invalidField) invalidField = phoneInput;
            }

            // Date of Birth validation
            const dobValue = dobInput.value;
            const today = new Date();
            const birthDate = new Date(dobValue);
            const age = calculateAge(dobValue);
            if (!dobValue) {
                errors.push('Date of Birth is required.');
                dobInput.classList.add('highlight-error');
                if (!invalidField) invalidField = dobInput;
            } else if (birthDate >= today) {
                errors.push('Date of Birth must be in the past.');
                dobInput.classList.add('highlight-error');
                if (!invalidField) invalidField = dobInput;
            } else if (age < 18) {
                errors.push('You must be at least 18 years old.');
                dobInput.classList.add('highlight-error');
                if (!invalidField) invalidField = dobInput;
            }

            // Gender validation
            const genderValue = genderSelect.value;
            if (!genderValue) {
                errors.push('Gender is required.');
                genderSelect.classList.add('highlight-error');
                if (!invalidField) invalidField = genderSelect;
            }

            // Address validation
            const streetValue = streetInput.value.trim();
            const cityValue = cityInput.value.trim();
            const stateValue = stateInput.value.trim().toUpperCase();
            const zipcodeValue = zipcodeInput.value.trim();

            //const streetRegex = /\d+\s+[A-Za-z\s]+/; // Number and text
            const streetRegex = /\d+\s+[\w\s]+/;
            const cityRegex = /^[A-Za-z\s-]+$/; // Letters, spaces, hyphens
            const stateRegex = /^[A-Z]{2}$/; // 2 letters
            const zipcodeRegex = /^\d{5}$/; // 5 digits

            if (!streetValue) {
                errors.push('Street is required.');
                streetInput.classList.add('highlight-error');
                if (!invalidField) invalidField = streetInput;
            } else if (!streetRegex.test(streetValue)) {
                errors.push('Street must include a number followed by a street name (e.g., 123 Main St or 1954 25th Dr SW).');
                streetInput.classList.add('highlight-error');
                if (!invalidField) invalidField = streetInput;
            }

            if (!cityValue) {
                errors.push('City is required.');
                cityInput.classList.add('highlight-error');
                if (!invalidField) invalidField = cityInput;
            } else if (!cityRegex.test(cityValue)) {
                errors.push('City must contain only letters, spaces, or hyphens.');
                cityInput.classList.add('highlight-error');
                if (!invalidField) invalidField = cityInput;
            }

            if (!stateValue) {
                errors.push('State is required.');
                stateInput.classList.add('highlight-error');
                if (!invalidField) invalidField = stateInput;
            } else if (!stateRegex.test(stateValue)) {
                errors.push('State must be a 2-letter US state code (e.g., TX).');
                stateInput.classList.add('highlight-error');
                if (!invalidField) invalidField = stateInput;
            }

            if (!zipcodeValue) {
                errors.push('Zipcode is required.');
                zipcodeInput.classList.add('highlight-error');
                if (!invalidField) invalidField = zipcodeInput;
            } else if (!zipcodeRegex.test(zipcodeValue)) {
                errors.push('Zipcode must be exactly 5 digits (e.g., 12345).');
                zipcodeInput.classList.add('highlight-error');
                if (!invalidField) invalidField = zipcodeInput;
            }

            // Form of ID validation
            const idTypeValue = idTypeSelect.value;
            if (!idTypeValue) {
                errors.push('Form of ID is required.');
                idTypeSelect.classList.add('highlight-error');
                if (!invalidField) invalidField = idTypeSelect;
            }

            // Validate file uploads
              const maxFileSize = 10 * 1024 * 1024; // 5MB in bytes
              const validImageTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/bmp', 'image/heic', 'image/heif'];

              if (!frontIdInput.files[0] || !backIdInput.files[0]) {
                errors.push('Please upload both front and back of your ID.');
                if (!frontIdInput.files[0]) frontIdInput.classList.add('highlight-error');
                if (!backIdInput.files[0]) backIdInput.classList.add('highlight-error');
                if (!invalidField && !frontIdInput.files[0]) invalidField = frontIdInput;
                else if (!invalidField && !backIdInput.files[0]) invalidField = backIdInput;
              } else {
                // Validate front ID
                const frontFile = frontIdInput.files[0];
                if (!validImageTypes.includes(frontFile.type)) {
                  errors.push('Front ID must be a valid image (JPEG, PNG, GIF, BMP, HEIC).');
                  frontIdInput.classList.add('highlight-error');
                  if (!invalidField) invalidField = frontIdInput;
                }
                if (frontFile.size > maxFileSize) {
                  errors.push('Front ID file size exceeds 10MB limit.');
                  frontIdInput.classList.add('highlight-error');
                  if (!invalidField) invalidField = frontIdInput;
                }

                // Validate back ID
                const backFile = backIdInput.files[0];
                if (!validImageTypes.includes(backFile.type)) {
                  errors.push('Back ID must be a valid image (JPEG, PNG, GIF, BMP, HEIC).');
                  backIdInput.classList.add('highlight-error');
                  if (!invalidField) invalidField = backIdInput;
                }
                if (backFile.size > maxFileSize) {
                  errors.push('Back ID file size exceeds 10MB limit.');
                  backIdInput.classList.add('highlight-error');
                  if (!invalidField) invalidField = backIdInput;
                }
              }

            // Handle validation errors
            if (errors.length > 0) {
                errorMessage.textContent = errors.join('\n'); // Use newline instead of space
                errorMessage.style.display = 'block';
                if (invalidField) invalidField.focus();
                console.log('Validation errors:', errors);
                return;
            }

            // If validation passes, store name and proceed
            fullName = fullNameValue;
            initials = getInitials(fullName);
            console.log('Personal info validated. Full Name: ' + fullName + ', Initials: ' + initials);
            showPage('tattoo-description-page');
        }

        // Validate tattoo description and proceed to signature preference page
        function proceedToSignaturePreference() {
            console.log('Validating tattoo description');
            const form = document.getElementById('tattoo-description-form');
            const errorMessage = document.querySelector('#tattoo-description-page .error-message');
            errorMessage.style.display = 'none';
            errorMessage.textContent = '';
            let invalidField = null;
            let errors = [];

            // Get all input fields
            const placementTextarea = document.getElementById('placement');
            const sizeSelect = document.getElementById('size');
            const inkSelectionSelect = document.getElementById('ink-selection');

            // Reset highlight on all fields
            [placementTextarea, sizeSelect, inkSelectionSelect].forEach(element => {
                element.classList.remove('highlight-error');
            });

            // Placement validation
            const placementValue = placementTextarea.value.trim();
            if (!placementValue) {
                errors.push('Placement is required.');
                placementTextarea.classList.add('highlight-error');
                if (!invalidField) invalidField = placementTextarea;
            }

            // Size validation
            const sizeValue = sizeSelect.value;
            if (!sizeValue) {
                errors.push('Size is required.');
                sizeSelect.classList.add('highlight-error');
                if (!invalidField) invalidField = sizeSelect;
            }

            // Ink Selection validation
            const inkSelectionValue = inkSelectionSelect.value;
            if (!inkSelectionValue) {
                errors.push('Ink Selection is required.');
                inkSelectionSelect.classList.add('highlight-error');
                if (!invalidField) invalidField = inkSelectionSelect;
            }

            // Handle validation errors
            if (errors.length > 0) {
                errorMessage.textContent = errors.join('\n'); // Use newline instead of space
                errorMessage.style.display = 'block';
                if (invalidField) invalidField.focus();
                console.log('Validation errors in tattoo description:', errors);
                return;
            }

            console.log('Tattoo description validated. Proceeding to signature preference');
            showPage('signature-preference-page');
            // Update preview when showing the page
              if (signatureMethod === 'adopt') {
                  updatePreview();
              }
        }

        // Validate signature preference and proceed to consent form page
        function proceedToConsentForm() {
            console.log('Validating signature preference');
            const signatureMethodSelect = document.getElementById('signature-method');
            const errorMessage = document.querySelector('#signature-preference-page .error-message');
            errorMessage.style.display = 'none';
            errorMessage.textContent = '';

            if (!signatureMethodSelect.value) {
                errorMessage.textContent = 'Please select a signature method.';
                errorMessage.style.display = 'block';
                signatureMethodSelect.classList.add('highlight-error');
                signatureMethodSelect.focus();
                console.log('Error: Signature method not selected');
                return;
            } else {
                signatureMethodSelect.classList.remove('highlight-error');
            }

            if (signatureMethod === 'adopt' && !document.getElementById('font-style').value) {
                errorMessage.textContent = 'Please select a font style.';
                errorMessage.style.display = 'block';
                const fontStyleSelect = document.getElementById('font-style');
                fontStyleSelect.classList.add('highlight-error');
                fontStyleSelect.focus();
                console.log('Error: Font style not selected for adopt method');
                return;
            }

            console.log('Signature preference validated. Proceeding to consent form');
            generateConsentItems();
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            showPage('consent-form-page');
        }

        // Generate consent items dynamically based on signature method
        function generateConsentItems() {
            console.log('Generating consent items');
            const items = [
                'I, [CLIENT NAME], have been fully informed of the inherent risks associated with getting a tattoo. Therefore, I fully understand that these risks, known and unknown, can lead to injury including but not limited to: infection, scarring, difficulties in the detection of melanoma and allergic reactions to tattoo pigment, latex gloves and/or soap. Having been informed of the potential risks associated with getting a tattoo I wish to proceed with the tattoo procedure and application and freely accept and expressly assume any and all risks that may arise from tattooing.',
                'I WAIVE AND RELEASE to the fullest extent permitted by law any person of the Tattoo Studio from all liability whatsoever, including but not limited to, any and all claims or causes of action that I, my estate, heirs, executors or assigns may have for personal injury or otherwise, including any direct and/or consequential damages, which result or arise from the procedure and application of my tattoo, whether caused by the negligence or fault of either the Tattoo Studio, or otherwise.',
                'The Tattoo Studio has given me the full opportunity to ask any question about the procedure and application of my tattoo and all of my questions, if any, have been answered to my total satisfaction.',
                'The Tattoo Studio has given me instructions on the care of my tattoo while it\'s healing. I understand and will follow them. I acknowledge that it is possible that the tattoo can become infected, particularly if I do not follow the instructions given to me.',
                'I am not under the influence of alcohol or drugs, and I am voluntarily submitting to be tattooed by the Tattoo Studio without duress or coercion.',
                'I do not suffer from diabetes, epilepsy, hemophilia, heart condition(s), nor do I take blood thinning medication. I do not have any other medical or skin condition that may interfere with the procedure, application or healing of the tattoo. I am not the recipient of an organ or bone marrow transplant or, if I am, I have taken the prescribed preventative regimen of antibiotics that is required by my doctor in advance of any invasive procedure such as tattooing. I am not pregnant or nursing. I do not have a mental impairment that may affect my judgement in getting the tattoo.',
                'The Tattoo Studio is not responsible for the meaning or spelling of the symbol or text that I have provided to them or chosen from the flash (design) sheets.',
                'Variations in color and design may exist between the tattoo art I have selected and the actual tattoo when it is applied to my body. I also understand that over time, the colors and the clarity of my tattoo will fade due to unprotected exposure to the sun and the naturally occurring dispersion of pigment under the skin.',
                'A tattoo is a permanent change to my appearance and can only be removed by laser or surgical means, which can be disfiguring and/or costly and which in all likelihood will not result in the restoration of my skin to its exact appearance before being tattooed.',
                'I release the right to any photographs taken of me and the tattoo and give consent in advance to their reproduction in print or electronic form. (For assurance, if you do not initial this provision, please inform the Tattoo Studio NOT to take any pictures of you and your completed tattoo).',
                'I agree that the Tattoo Studio has a NO REFUND policy on tattoos, piercing and/or retail sales and I will not ask for a refund for any reason whatsoever.',
                'I agree to reimburse the Tattoo Studio for any attorneys\' fees and costs incurred in any legal action I bring against the Tattoo Studio and in which either the Artist of the Tattoo Studio is the prevailing party. I agree that the courts located in the County of Harris within the State of Texas shall have jurisdiction and venue over me and shall have exclusive jurisdiction for the purposes of litigating any dispute arising out of or related to this agreement.',
                'I acknowledge that I have been given adequate opportunity to read and understand this document that it was not presented to me at the last minute and grasp that I am signing a legal contract waiving certain rights to recover damages against the Tattoo Studio. If any provision, section, subsection, clause or phrase of this release is found to be unenforceable or invalid, that portion shall be severed from this contract. The remainder of this contract will then be construed as though the unenforceable portion had never been contained in this document. I hereby declare that I am of legal age (and have provided valid proof of age and identification) and am competent to sign this Agreement.',
                'I have received a copy of applicable written care instructions and I have read and understand such written care instructions.',
                'I consent to the use of electronic signatures and records.'
            ];

            const consentItemsDiv = document.getElementById('consent-items');
            consentItemsDiv.innerHTML = '';
            items.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'consent-item';
                const paragraphText = item.replace('[CLIENT NAME]', fullName);
                itemDiv.innerHTML = `<p>${index + 1}. ${paragraphText}</p>`;
                if (signatureMethod === 'manual') {
                    const initialInput = document.createElement('input');
                    initialInput.type = 'text';
                    initialInput.id = `initial-${index}`;
                    initialInput.placeholder = 'Initial';
                    initialInput.required = true;
                    itemDiv.insertBefore(initialInput, itemDiv.firstChild);
                } else {
                    const initialButton = document.createElement('button');
                    initialButton.textContent = 'Click to Initial';
                    initialButton.onclick = () => adoptInitial(index);
                    itemDiv.insertBefore(initialButton, itemDiv.firstChild);
                    const initialText = document.createElement('span');
                    initialText.id = `initial-text-${index}`;
                    itemDiv.insertBefore(initialText, initialButton.nextSibling);
                }
                consentItemsDiv.appendChild(itemDiv);
            });

            const finalStatement = document.createElement('p');
            finalStatement.textContent = 'I HAVE READ THE AGREEMENT, I UNDERSTAND IT, AND I AGREE TO BE BOUND BY IT.';
            finalStatement.style.textAlign = 'justify';
            consentItemsDiv.appendChild(finalStatement);

            if (signatureMethod === 'manual') {
                document.getElementById('signature-pad').style.display = 'block';
                document.getElementById('adopt-signature').style.display = 'none';
                const canvas = document.getElementById('signature-canvas');
                
                // Set canvas attributes to match CSS size for accurate drawing
                const canvasWidth = 600; // Match max-width in CSS
                const canvasHeight = 120; // Match height in CSS
                canvas.width = canvasWidth;
                canvas.height = canvasHeight;
                
                // Initialize SignaturePad with the canvas
                signaturePad = new SignaturePad(canvas, {
                    minWidth: 1, // Minimum stroke width
                    maxWidth: 2.5, // Maximum stroke width
                    penColor: 'black' // Pen color
                });
                
                // Adjust canvas size on window resize for responsiveness
                function resizeCanvas() {
                    const ratio = Math.max(window.devicePixelRatio || 1, 1);
                    const newWidth = Math.min(canvasWidth, window.innerWidth - 40); // Adjust for padding/margins
                    canvas.width = newWidth * ratio;
                    canvas.height = canvasHeight * ratio;
                    canvas.getContext('2d').scale(ratio, ratio);
                    signaturePad.clear(); // Clear on resize to avoid distortion
                    console.log('Canvas resized to width: ' + canvas.width + ', height: ' + canvas.height);
                }
                window.addEventListener('resize', resizeCanvas);
                resizeCanvas(); // Initial call to set size
                
                console.log('Manual signature pad initialized with width: ' + canvas.width + ', height: ' + canvas.height);
            } else {
                document.getElementById('signature-pad').style.display = 'none';
                document.getElementById('adopt-signature').style.display = 'block';
                console.log('Adopt signature section displayed');
            }
            console.log('Consent items generated');
        }

        // Adopt initials for a specific consent item (adopt method)
        function adoptInitial(index) {
            console.log(`Adopting initial for item ${index}`);
            const initialText = document.getElementById(`initial-text-${index}`);
            initialText.textContent = initials;
            initialText.style.fontFamily = selectedFont;
            initialText.dataset.signed = 'true';
            const button = initialText.previousSibling;
            button.style.display = 'none';
            console.log(`Initial adopted for item ${index}: ${initials}`);
        }

        // Adopt the signature (adopt method)
        function adoptSignature() {
            console.log('Adopting signature');
            const signatureSection = document.getElementById('adopt-signature');
            const button = signatureSection.querySelector('button');
            const signatureText = document.getElementById('signature-text');
            signatureText.textContent = fullName;
            signatureText.style.fontFamily = selectedFont;
            signatureText.classList.add('adopted-signature');
            signatureText.dataset.signed = 'true';
            button.style.display = 'none';
            console.log('Signature adopted: ' + fullName);
        }

        // Clear the manual signature pad
        function clearSignature() {
            console.log('Clearing signature');
            signaturePad.clear();
            document.getElementById('signature-canvas').classList.remove('highlight-error');
            console.log('Signature cleared');
        }

        // Submit the form after validating consent items and signature
        function submitForm() {
            console.log('Submit button clicked');
            const errorMessage = document.querySelector('#consent-form-page .error-message');
            errorMessage.style.display = 'none';
            errorMessage.textContent = '';

            if (signatureMethod === 'adopt') {
                const unsignedInitialButtons = document.querySelectorAll('#consent-items button:not([style*="display: none"])');
                if (unsignedInitialButtons.length > 0) {
                    unsignedInitialButtons.forEach(button => button.classList.add('highlight-error'));
                    errorMessage.textContent = 'Please initial all items by clicking the buttons.';
                    errorMessage.style.display = 'block';
                    unsignedInitialButtons[0].scrollIntoView({ behavior: 'smooth' });
                    console.log('Error: Unsigned initial buttons detected');
                    return;
                }
                const signatureButton = document.querySelector('#adopt-signature button');
                if (signatureButton && signatureButton.style.display !== 'none') {
                    signatureButton.classList.add('highlight-error');
                    errorMessage.textContent = 'Please click to sign.';
                    errorMessage.style.display = 'block';
                    signatureButton.scrollIntoView({ behavior: 'smooth' });
                    console.log('Error: Signature not adopted');
                    return;
                }
            } else {
                const initialInputs = document.querySelectorAll('#consent-items input');
                let firstEmpty = null;
                initialInputs.forEach(input => {
                    if (!input.value.trim()) {
                        input.classList.add('highlight-error');
                        if (!firstEmpty) firstEmpty = input;
                    } else {
                        input.classList.remove('highlight-error');
                    }
                });
                if (firstEmpty) {
                    errorMessage.textContent = 'Please initial all items.';
                    errorMessage.style.display = 'block';
                    firstEmpty.scrollIntoView({ behavior: 'smooth' });
                    console.log('Error: Missing initials in manual method');
                    return;
                }
                if (signaturePad.isEmpty()) {
                    document.getElementById('signature-canvas').classList.add('highlight-error');
                    errorMessage.textContent = 'Please provide your signature.';
                    errorMessage.style.display = 'block';
                    document.getElementById('signature-canvas').scrollIntoView({ behavior: 'smooth' });
                    console.log('Error: Signature missing in manual method');
                    return;
                }
            }

            // Collect form data for submission
            const formData = {
                fullName: document.getElementById('full-name-info').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                gender: document.getElementById('gender').value,
                address: {
                    street: document.getElementById('street').value,
                    city: document.getElementById('city').value,
                    state: document.getElementById('state').value,
                    zipcode: document.getElementById('zipcode').value
                },
                dob: document.getElementById('dob').value,
                idType: document.getElementById('id-type').value,
                tattooDetails: {
                    placement: document.getElementById('placement').value,
                    size: document.getElementById('size').value,
                    inkSelection: document.getElementById('ink-selection').value
                },
                date: document.getElementById('date').value,
                frontIdFile: document.getElementById('front-id').files[0],
                backIdFile: document.getElementById('back-id').files[0],
                initials: signatureMethod === 'manual' ? Array.from(document.querySelectorAll('[id^=initial-]')).map(input => input.value) : Array(15).fill(initials),
                signature: signatureMethod === 'manual' ? signaturePad.toDataURL() : fullName
            };

            console.log('Form Data Collected:', formData);

            const age = calculateAge(formData.dob);
            document.getElementById('loading').style.display = 'block';
            console.log('Showing loading indicator');

            const data = {
                fullName: formData.fullName,
                email: formData.email,
                phone: formData.phone,
                gender: formData.gender,
                address: formData.address,
                dob: formData.dob,
                age: age,
                idType: formData.idType,
                tattooDetails: formData.tattooDetails,
                signatureMethod: signatureMethod,
                selectedFont: selectedFont,
                date: formData.date,
                initials: formData.initials,
                signature: formData.signature
            };

            // Read and encode file uploads
            const reader = new FileReader();
            reader.onload = () => {
                console.log('Front ID file loaded');
                data.frontId = reader.result;
                const reader2 = new FileReader();
                reader2.onload = () => {
                    console.log('Back ID file loaded');
                    data.backId = reader2.result;
                    console.log('Submitting form to server');
                    google.script.run
                        .withSuccessHandler(onSuccess)
                        .withFailureHandler(onFailure)
                        .submitForm(data);
                };
                reader2.readAsDataURL(formData.backIdFile);
            };
            reader.readAsDataURL(formData.frontIdFile);
        }

        // Handle successful form submission from server
       // Handle successful form submission from server
        // Handle successful form submission from server
        function onSuccess(response) {
            console.log('Form submission response:', response);
            if (response.status === 'success') {
                showPage('thank-you-page');
                document.getElementById('thankYouMessage').textContent = `Thank you ${response.firstName}`;
                var submissionMessage = document.getElementById('submissionMessage');
                if (submissionMessage) {
                    submissionMessage.innerHTML = `Your consent form has been submitted successfully. You will receive an email with the form shortly.<br>
                        We’d love to stay connected with you! Please follow us on social media to see our latest work, updates, and promotions:`;
                }
                var socialMediaLinks = document.getElementById('socialMediaLinks');
                if (socialMediaLinks && socialMediaData) {
                    socialMediaLinks.innerHTML = `
                        <div class="social-media-item">
                            <i class="uil uil-instagram"></i>
                            <a href="${socialMediaData.instagramLink}" target="_blank">Follow us on Instagram: ${socialMediaData.instagramHandle}</a>
                        </div>
                        <div class="social-media-item">
                            <i class="uil uil-facebook-f"></i>
                            <a href="${socialMediaData.facebookLink}" target="_blank">Like our Facebook page: ${socialMediaData.facebookPage}</a>
                        </div>
                    `;
                } else {
                    console.error('Error: socialMediaLinks or socialMediaData unavailable');
                }
            } else if (response === 'quota_exceeded') {
                const errorMessage = document.querySelector('#consent-form-page .error-message');
                errorMessage.textContent = "We're sorry, but we've hit our daily limit on form submissions. Please try again in 24 hours.";
                errorMessage.style.display = 'block';
                document.getElementById('loading').style.display = 'none';
                console.log('Quota exceeded, submission aborted');
            } else {
                console.log('Form submission failed');
                alert('Form submission failed. Please try again.');
            }
        }
        // Handle form submission failure from server
        function onFailure(error) {
            console.log('Submission failed: ' + error.message);
            showPage('consent-form-page');
            const errorMessage = document.querySelector('#consent-form-page .error-message');
            errorMessage.textContent = `Error submitting form: ${error.message}`;
            errorMessage.style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }
    </script>
</body>
</html>